name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI devops 2024"]
    types:
      - completed
    branches: 
      - main

jobs:
  run-main-playbook:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Copy SSH key
      run: |
        mkdir -p ~/.ssh
        cp ~/id_rsa ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H yourserver.com >> ~/.ssh/known_hosts

    - name: Set up Ansible
      run: |
        sudo apt update
        sudo apt install ansible -y

    - name: Run main playbook
      run: |
        ansible-playbook -i inventories/setup.yml my-project/ansible/playbook.yml
      continue-on-error: false

